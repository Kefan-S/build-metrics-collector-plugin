<html>
<header>
  <meta charset="utf-8">
  <title>Opal</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@4.7.0/dist/echarts.min.js"></script>
  <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
</header>
<style>
  .opalChart {
    height: 400px;
    width: 600px;
    float: left;
  }
</style>
<body>
<div>
  <div id="recoverTime" class="opalChart"></div>
  <div id="leadTime" class="opalChart"></div>
  <div id="deployFrequency" class="opalChart"></div>
  <div id="failureRate" class="opalChart"></div>
  <div id="avgDuration" class="opalChart"></div>
</div>
</body>
<script type="text/javascript">
  // 基于准备好的dom，初始化echarts实例
  var recoverTime = echarts.init(document.getElementById('recoverTime'));
  var leadTime = echarts.init(document.getElementById('leadTime'));
  var avgDuration = echarts.init(document.getElementById('avgDuration'));
  var failureRate = echarts.init(document.getElementById('failureRate'));
  var deployFrequency = echarts.init(document.getElementById('deployFrequency'));

  let durationcalculate = function (value) {
    var millisecond = new Number(value);
    var days = parseInt(millisecond / (1000 * 60 * 60 * 24));
    var hours = parseInt((millisecond % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    var minutes = parseInt((millisecond % (1000 * 60 * 60)) / (1000 * 60));
    var seconds = (millisecond % (1000 * 60)) / 1000;
    var time = ""
    if(days) time = time + days + " 天 ";
    if(hours) time = time + hours + " 小时 ";
    if(minutes) time = time + minutes + " 分 ";
    if(seconds) time = time + seconds + " 秒 ";
    return time;
  };

  let timeStampTranslator = {
    formatter: function (value, index) {
      // 格式化成月/日，只在第一个刻度显示年份
      console.warn(value)
      var date = new Date(new Number(value) * 1000);
      var texts = [(date.getMonth() + 1), date.getDate()];
      if (index === 0) {
        texts.unshift(1900 + date.getYear());
      }
      return texts.join('/');
    }
  };

  function lineChartOpationGenerator(chartName, xAxisData, yAxisData,
      yAxisName , xAxisName = "Start Time") {
    return {
      title: {
        text: chartName
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          animation: false
        }
      },
      xAxis: {
        name: xAxisName,
        type: 'category',
        data: xAxisData,
        axisLabel: timeStampTranslator
      },
      yAxis: {
        name: yAxisName,
        type: 'value',
        axisLabel: {
          formatter: durationcalculate
        }
      },
      series: [{
        data: yAxisData,
        type: 'line',
        smooth: true
      }]
    }
  }

  function gagueChartOpationGenerator(chartName, data, formatter) {
    return {
      title: {
        text: 'chartName'
      },
      tooltip: {
        formatter: '{a} <br/>{b} : {c}%'
      },
      toolbox: {
        feature: {
          restore: {},
          saveAsImage: {}
        }
      },
      series: [
        {
          name: '业务指标',
          type: 'gauge',
          detail: {formatter: formatter},
          data: [{value: data, name: '失败率'}]
        }
      ]
    }
  }

  setInterval(function () {
    $.get("http://localhost:8083/hello", function (data, status) {
      console.log(data)
      recoverTime.setOption(lineChartOpationGenerator('Recover Time', data.startTime, data.recoverTime, "Recover Time", "Start Time"));
      leadTime.setOption(lineChartOpationGenerator('Lead Time', data.startTime, data.leadTime, "Lead Time", "Start Time"));
      avgDuration.setOption(lineChartOpationGenerator('Duration', data.startTime, data.duration, "Duration", "Start Time"));
      failureRate.setOption(gagueChartOpationGenerator("Failure Rate", data.failureRate, "{value}%", '失败率'));
      deployFrequency.setOption(gagueChartOpationGenerator("Deploy Frequency", data.deploymentFrequency, "{value}", '部署频率'));
    })
  }, 2000);
</script>
</html>
